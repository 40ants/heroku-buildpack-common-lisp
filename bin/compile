#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# parse and derive params
# shellcheck disable=SC2164
# shellcheck disable=SC2046
BUILDPACK_DIR=$(cd $(dirname "$0"); cd ..; pwd) # absolute path of buildpack

BUILD_DIR=$1
CACHE_DIR=$2

echo "-----> CCL buildpack 0.1"

echo "-----> start buildpack's compile"
echo "build_dir: $BUILD_DIR"
echo "cache_dir: $CACHE_DIR"
echo "env_dir: $ENV_DIR"

find "$ENV_DIR" -exec echo {} \; -exec ls -l {} \; -exec echo \;

if [ "$RESET_CACHE" ]; then
  echo "-----> flushing cache"
  rm -rf "${CACHEDIR:?}/"*
fi

if [ -f "$ENV_DIR/CL_IMPL" ]; then
    CL_IMPL=$(cat "$ENV_DIR/CL_IMPL")
else
    CL_IMPL="ccl-bin"
fi

if [ ! "$CL_IMPL" ]; then
    CL_IMPL="ccl-bin"
fi

git clone -b release https://github.com/roswell/roswell.git
pushd roswell || exit
sh bootstrap
./configure --prefix ~/.local/
make
make install
export PATH=$PATH:~/.local/bin/
ros setup
ros install "$CL_IMPL"
ros use "$CL_IMPL"
popd || exit

echo "-----> create slug's lispapp"
export BUILDPACK_DIR
export CACHE_DIR
export BUILD_DIR

echo "using the buildpack's setup/compile.lisp, asdf, quicklisp, and save-application"
ros run --asdf --load "$BUILDPACK_DIR/setup/compile.lisp" --quit
echo "-----> Build finished"

chmod a+x "$BUILD_DIR/lispapp"
